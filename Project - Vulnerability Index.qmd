---
title: "Project - Vulnerability Index"
author: "Valentine Petzold - Clémence HUANG"
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    code-fold: true
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = TRUE,
  message = FALSE,
  warning = FALSE
)
```

# 1. Introduction

[Link to our github repository](https://github.com/clemence-code/Data_management_Project)

## 1.1 Description of the project - Research question

Climate change acts as a "threat multiplier", exacerbating existing inequalities and creating new risks for nations worldwide. However, the impact of climate change is not uniform; a similar physical shock, such as a heatwave or flood, can devastate one country while leaving another relatively unscathed. This disparity is driven not just by geography, but by the socio-economic and institutional fabric of a nation. Consequently, the objective of this project is to construct a Climate Vulnerability Index. We adopt the framework often cited in IPCC reports, which conceptually defines vulnerability as a function of three dimensions: Exposure, sensitivity and adaptive capacity.

By explicitly combining these dimensions using transparent data and methods, we aim to better understand which factors drive a country’s vulnerability and to identify profiles of countries that may require differentiated policy responses. This leads us to the following research question: **How can a composite climate vulnerability index be used to compare countries and support more targeted and equitable climate adaptation policies ?**

To operationalize our index, we broke the concept of vulnerability down into three specific sub-dimensions. First, we focused on Exposure, which represents the physical reality of climate change. We view this dimension as largely exogenous because a country cannot simply change its geography away natural hazards. For our model, we selected Temperature Change as the primary indicator, using it as a proxy for the increasing thermal stress that drives other physical disasters like droughts and wildfires.

Moving beyond the physical shock, we defined Sensitivity as the social component—essentially, how much a country’s "pre-existing conditions" make it vulnerable to harm. We argue that a society’s sensitivity depends heavily on its socio-economic fragility. Therefore, we incorporated the Human Development Index (HDI), reasoning that higher levels of human development are often associated with stronger institutions capable of organizing evacuations, coordinating emergency response, and ensuring efficient resource distribution during crises. We also decided to include income inequality, more equal societies generally exhibit higher social cohesion, which facilitates collective action, adherence to prevention measures, and the circulation of critical information during climate-related events.

Finally, we defined Adaptive Capacity as the institutional component, which reflects a country's ability to adjust and cope with consequences. Unlike Exposure, this is the dimension where we believe government policy can make the biggest difference. We chose to measure this through two main lenses: fiscal and technological. To capture fiscal capacity, we used Environmental Protection Expenditures, which shows us how much financial priority a government assigns to these issues. For technological capacity, we looked at the Renewable Energy Share, assuming that transitioning away from fossil fuels increases a country's energy independence and overall resilience.

Methodologically, the project will involve selecting, normalizing and aggregating indicators within each dimension, and then combining the three dimensions into a composite index of climate vulnerability. We will carefully examine correlations between variables to avoid redundancy and ensure that each indicator brings distinct information. Different weighting schemes (equal weights, data-driven weights, or robustness checks with alternative specifications) may be compared. Finally, the resulting index will be analysed descriptively to identify patterns of vulnerability across countries (for example, highly exposed but relatively resilient countries versus highly sensitive and poorly equipped ones).

## 1.2 Description of data sources

-   [International monetary fund](https://www.imf.org/en/home) : The Macroeconomic Climate Indicators Dashboard (climatedata.imf.org) is an online resource from the International Monetary Fund (IMF) that provides data-driven insights at the intersection of climate and the economy. It features a range of indicators, developed in collaboration with other international organizations, which demonstrate how economic activity is impacting climate change and what governments are doing to mitigate these effects.
    - [Environmental Protection Expenditures](https://climatedata.imf.org/datasets/d22a6decd9b147fd9040f793082b219b/explore)
    - [Annual Surface Temperature Change](https://climatedata.imf.org/pages/climatechange-data)
- [United Nations Development Programme (UNDP) - Human development Report Office](https://hdr.undp.org/) : UNDP is the UN’s global development network, working in around 170 countries and territories to eradicate poverty, reduce inequalities and build resilient institutions. Within UNDP, the Human Development Report Office (HDRO) is responsible for producing the annual Human Development Report and developing the Human Development Index (HDI) and related indicators, which provide a multidimensional view of development by combining health, education and income measures. 
  - [Index of Human Development (1990-2025)](https://hdr.undp.org/data-center/human-development-index#/indicies/HDI)
-   [World Inequality Database](https://wid.world/) : The World Inequality Lab is a research center based at the Paris School of Economics, bringing together economists and social scientists to study global and national inequalities in income, wealth and carbon emissions. It manages and develops the World Inequality Database (WID.world), which compiles harmonized, long-run series on the distribution of income and wealth, based on a combination of tax data, national accounts, surveys and other sources, with the aim of informing public debate and policy on inequality. [Income share of the top 10% and top 10% carbon emitters (1980-2023)](https://wid.world/data/)
-   [International Renewable Energy Agency](https://www.irena.org/) : IRENA is an intergovernmental agency that supports countries worldwide in their transition to a sustainable energy future by promoting renewable energy, providing data and analysis, and advising on energy policies and investments.
    -   [Electricity production from renewable sources (2000-2024)](https://pxweb.irena.org/pxweb/en/IRENASTAT)
-   [World bank](https://data.worldbank.org/) : The World Bank is an international financial institution headquartered in Washington, D.C., whose core mandate is to reduce poverty and promote sustainable development in low- and middle-income countries through financial support, technical assistance and policy advice. Beyond lending, the World Bank is one of the world’s main producers and disseminators of development statistics.
    -   [Per capita energy use (1990-2023)](https://data.worldbank.org/indicator/EN.GHG.CO2.PC.CE.AR5)
- [University of Notre Dame's Global Adaptation Initiative](https://gain.nd.edu/) : The University of Notre Dame's Global Adaptation Initiative (ND-GAIN) is a research program focused on understanding and quantifying how countries can adapt to a climate change. The [ND-GAIN Country Index](https://gain.nd.edu/our-work/country-index/) is a tool that summarizes a country's vulnerability to climate change and its readiness to improve resilience.

## 1.3 Description of the data file

To construct the composite vulnerability index, we implemented a three-step data harmonization process.

First, we performed cleaning and reshaping: we dropped extraneous metadata columns (like ObjectId and Source) from all datasets.

Second, we implemented ISO3C: we converted all varying country names into the standardized three-letter ISO3C code. 

Finally, we performed the panel creation: using the standardized ISO3C and year identifiers, we merged all long-format indicators into a single, unified panel dataset. 

### 1.3.0 Set up

```{r}
library(vroom)
library(here)
library(ggplot2)
library(dplyr)
library(readxl)
library(tidyr)
library(stringr)
library(purrr)
library(countrycode)
```

```{r}
rm(list = ls())
here::i_am('Data_management_Project.Rproj')
```

```{r}
zip_files <- list.files(
  here::here("raw_data"),
  pattern = "\\.zip$",
  full.names = TRUE
)

target_dir <- here::here("data_file")

# We unzip the zipfile in raw_data only if this folder is empty, so the extraction runs only once
if (length(list.files(target_dir)) == 0) {
  for (f in zip_files) {
    unzip(f, exdir = target_dir)
  }
}
```

### 1.3.1 Temperature change (IMF)

From 1961 to 2024, this dataset displays for countries and region of the world the temperature change with respect to a baseline climatology, corresponding to the period 1951-1980 in degree Celsius. 

To prepare the Annual Surface Temperature Change dataset for analysis, the primary cleaning step was focused on removing superfluous metadata and technical identifier columns. Specifically, we dropped columns such as ObjectId, ISO2, Indicator and Unit. 

```{r}
Temperature_change<-vroom(here("raw_data","Indicator_3_1_Climate_Indicators_Annual_Mean_Global_Surface_Temperature_577579683071085080.csv")) |>
  select(
    -ObjectId,
    -ISO2,
    -Indicator,
    -Unit,
    -Source,
    -`CTS Code`,
    -`CTS Name`,
    -`CTS Full Descriptor`
  )
```

### 1.3.2 Human Development index (UNDP)

This dataset contains annual values of the Human Development Index for most countries from 1990 onwards, combining indicators of life expectancy, education and gross national income per capita. It provides a synthetic measure of socio-economic development and human capabilities, which can be used to approximate countries’ social vulnerability and resilience to climate impacts.

We first imported the HDI Excel file while skipping the first three header rows that contain only documentation. We then removed all observations for which the first column was missing, in order to drop non-country or descriptive rows. Finally, we deleted all variables with more than 20% missing values, keeping only columns with sufficient data coverage for the analysis.

```{r}
HDI <- read_excel(here("raw_data","HDR25_Statistical_Annex_HDI_Table.xlsx."), skip=3)

HDI_clean <- HDI[!is.na(HDI[[1]]), ] |>
  slice(-1) |>
  select(where(~ mean(is.na(.x)) <= 0.2)) |>
  rename(
    "rank 2023"   = 1,
    Country = 2,
    "HDI Value" = 3,
    "Life expectancy at birth 2023" = 4,
    "Expected years of schooling 2023" = 5,
    "Mean years of schooling 2023" = 6,
    "Gross national income per capita 2021" = 7,
    "Gross national income rank minus HDI rank 2023" = 8,
    "HDI rank 2022" = 9
  )
```

### 1.3.3 Income share of the top 10% (WID)

This dataset offers series from 1990 to 2023 on the income share captured by the top 10% of earners.

```{r}
Top_10_income_share <- vroom(here("data_file","WID_Data_Metadata", "WID_Data_21112025-154904.csv"), delim=";",skip=1) |> select(-Percentile)

old_names <- names(Top_10_income_share)
year_only <- str_extract(old_names, "\\d{4}")

# keep the year when it exists, otherwise keep the original name
names(Top_10_income_share) <- ifelse(is.na(year_only), old_names, year_only)
```

### 1.3.4 Expenditure on environmental protection (IMF)

For the years 1995 to 2022, this dataset gathers the total amount of government expenditure toward environmental purposes like "Expenditure in waste management" or "Expenditure on pollution abatement" etc. They are expressed both in terms of domestic currency and of percentage of GDP. 

We will only keep percentage of GDP. We selected this metric over absolute currency values to ensure comparability. Absolute spending creates a bias toward larger economies; a wealthy nation will naturally spend more in total dollars than a smaller one, even if the smaller nation is more committed to environmental goals.

```{r}
Exp_env <- vroom(here("raw_data","Indicator_14_Expenditure_on_Environmental_Protection_-5612631162247205392.csv"))  |>
  select(
    -ObjectId,
    -ISO2,
    -Source,
    -`CTS Code`,
    -`CTS Name`,
    -`CTS Full Descriptor`
  ) |>
  filter(Unit == "Percent of GDP")
```

### 1.3.5 Share of electricity from renewable resources (IRENA)

Ember’s yearly electricity dataset provides, for each country, the breakdown of electricity generation by renewable technologies from 2000 to 2024. 

We first imported the Excel file while skipping the two initial header rows, then renamed the columns to country, indicator, year, and value for clarity. We filled down the country and indicator fields so that each observation has these identifiers, and removed rows where the year was missing. We then converted the year to an integer and transformed the values from character strings with commas into numeric variables. Finally, we kept only country-level observations by excluding regional aggregates such as World, Africa, Asia or Europe.

```{r}
RE_Electricity_Share <- read_excel(here("raw_data","RESHARE_20251121-201530.xlsx"),skip=2)
```

```{r}
RE_Electricity_Share_clean <- RE_Electricity_Share |>
  rename(
    Country   = 1,
    indicator = 2,
    year      = 3,
    value     = 4
  ) |>
  fill(Country, indicator, .direction = "down") |>
  filter(!is.na(year)) |>
  mutate(
    year  = as.integer(year),
    value = value |>
      as.character() |>
      str_replace(",", ".") |>
      as.numeric()
  )
```

### 1.3.6 Per capita energy use (World bank)

This World Bank indicator reports total primary energy consumption per capita, expressed in kilograms of oil equivalent, for a large set of countries over 1990 to 2023.

```{r}
PC_Energy_Use <- vroom(
  here("data_file","API_EG.USE.ELEC.KH.PC_DS2_en_csv_v2_129274.csv"),
  delim = ",",
  skip = 4
) |>
  select(where(~ !all(is.na(.)))) |>
  rename(Country=1,ISO3=2) |>
  select(-`Indicator Name`,-`Indicator Code`) |>
  filter(if_any(3:last_col(), ~ !is.na(.)))
```

### 1.3.7 ND-Gain vulnerability index

For 192 countries, this dataset displays a computed index of vulnerability for each from 1995 to 2023. This index of vulnerability developed by the University of Notre Dame, gather 45 indicators to assess both the vulnerability of a country to climate change and its readiness (i.e. capacity to adapt).

```{r}
vulnerability<- vroom(here("data_file","resources","vulnerability", "vulnerability.csv")) |>
  rename(Country = 2)
```

```{r}
vulnerability |> 
  summarise(
    number_of_rows = n(),
    number_of_columns = ncol(across()),
    number_of_NA = sum(is.na(across())),
    percent_of_NA = (number_of_NA / (number_of_rows * number_of_columns)) * 100
  ) |>
  knitr::kable()
```

### 1.3.8 CO2 emissions per capita (World Bank)

This dataset gathers for 1970 to 2024 tons of carbon dioxide (C02) emissions per capita.

```{r}
PC_CO2_emissions <- vroom(here("data_file","API_EN.GHG.CO2.PC.CE.AR5_DS2_en_csv_v2_127841.csv"),delim = ",", skip = 4)

PC_CO2_emissions <- PC_CO2_emissions |>
  select(where(~ !all(is.na(.)))) |>
  rename(Country=1,ISO3=2) |>
  select(-`Indicator Name`,-`Indicator Code`) |>
  filter(if_any(3:last_col(), ~ !is.na(.)))
```
 
# 2. Data joining

## 2.1 Harmonization of Country Identifiers

To ensure accurate merging across our heterogeneous data sources, we standardize all country identifiers. We defined a helper function, add_iso3_to_df, which utilizes the countrycode package to convert various country name formats into the standardized 3-letter ISO3C code.

```{r}
add_iso3_to_df <- function(df, country_col = "Country") {
  df |>
    mutate(ISO3 = countrycode(.data[[country_col]], 
                              origin = "country.name", 
                              destination = "iso3c")) |>
    filter(!is.na(ISO3))
}

Temperature_change     <- Temperature_change |> add_iso3_to_df("Country")
Exp_env                <- Exp_env |> add_iso3_to_df("Country")
PC_Energy_Use          <- PC_Energy_Use |> add_iso3_to_df("Country")
RE_Electricity_Share   <- RE_Electricity_Share_clean |> add_iso3_to_df("Country")
Top_10_income_share    <- Top_10_income_share |> add_iso3_to_df("Country")
HDI_clean              <- HDI_clean |> add_iso3_to_df("Country")
vulnerability          <- vulnerability |> add_iso3_to_df("Country")
PC_CO2_emissions       <- PC_CO2_emissions |> add_iso3_to_df("Country")
```

## 2.2 Reshaping to Long Format

Most of the source data was imported in a "wide" format, where years are spread across multiple columns. To create a panel dataset suitable for longitudinal analysis, we reshape each dataframe into a "long" format. In this structure, each row represents a unique Country-Year observation.

```{r}
Temperature_long <- Temperature_change |>
  select(ISO3, matches("^\\d{4}$")) |>
  pivot_longer(cols = matches("^\\d{4}$"), names_to = "year", values_to = "temp_change") |>
  mutate(year = as.integer(year))

Exp_env_long <- Exp_env |>
  select(ISO3, matches("^\\d{4}$")) |>
  pivot_longer(cols = matches("^\\d{4}$"), names_to = "year", values_to = "exp_env_pct_gdp") |>
  mutate(year = as.integer(year))

PC_Energy_long <- PC_Energy_Use |>
  select(ISO3, matches("^\\d{4}$")) |>
  pivot_longer(cols = matches("^\\d{4}$"), names_to = "year", values_to = "pc_energy_use") |>
  mutate(year = as.integer(year))

RE_long <- RE_Electricity_Share |>
  transmute(ISO3, year = as.integer(year), renew_elec_share = value)

Top10_long <- Top_10_income_share |>
  select(ISO3, matches("^\\d{4}$")) |>
  pivot_longer(cols = matches("^\\d{4}$"), names_to = "year", values_to = "top10_income_share") |>
  mutate(year = as.integer(year))

PC_CO2_long <- PC_CO2_emissions |>
  select(ISO3, matches("^\\d{4}$")) |>
  pivot_longer(cols = matches("^\\d{4}$"), names_to = "year", values_to = "pc_co2") |>
  mutate(year = as.integer(year))
```

## 2.3 Panel Merging

We merge all six transformed datasets into a single unified panel using a full_join approach. This ensures that no data is discarded initially, even if a country is missing from one of the sources. We then re-attach a standardized country name based on the ISO3 codes for readability.

```{r}
datasets_long <- list(
  Temperature_long,
  Exp_env_long,
  PC_Energy_long,
  RE_long,
  Top10_long,
  PC_CO2_long
)

panel_full <- reduce(datasets_long, ~ full_join(.x, .y, by = c("ISO3", "year")))

panel_full <- panel_full |>
  mutate(Country = countrycode(ISO3, "iso3c", "country.name")) |>
  relocate(ISO3, Country, year) |>
  filter(!is.na(Country))
```

## 2.4 Data Cleaning and Country Selection

Finally, we assess the coverage of our panel. First, we identify the total number of unique countries available in the merged dataset. Then, to ensure the robustness of our vulnerability index, we filter the panel to retain only those countries that possess at least one valid observation for every variable. This removes countries that are entirely missing a specific dataset (e.g., countries with no CO2 data or no Inequality data), resulting in a consistent "matched panel" for our final index construction.

```{r}
panel_full |>
  summarise(total_countries = n_distinct(ISO3))

country_list <- panel_full |>
  distinct(Country, ISO3) |>
  arrange(Country)

panel_complete_vars <- panel_full |>
  group_by(Country) |>
  filter(if_all(everything(), ~ any(!is.na(.)))) |>
  ungroup()

n_distinct(panel_complete_vars$Country)
```

## 2.5 Summary tables

## 2.5.1 Global Data Assessment

Before proceeding with the construction of the index, it is essential to assess the overall sparsity of the matched panel. The following tables provide a high-level overview of the dataset dimensions and the distribution of missing values across the different variables. This step identifies which indicators act as "bottlenecks" for data availability.

```{r}
summary_stats <- panel_complete_vars |>
  summarise(
    `Number of Rows` = n(),
    `Number of Columns` = ncol(panel_complete_vars),
    `Total NA Values` = sum(is.na(across(everything()))),
    `% of NA` = (sum(is.na(across(everything()))) / (n() * ncol(panel_complete_vars))) * 100
  ) |>
  mutate(`% of NA` = round(`% of NA`, 2))

summary_stats |>
  knitr::kable(caption = "Overview of the final matched panel dataset")

na_by_column <- panel_complete_vars |>
  summarise(across(everything(), ~ sum(is.na(.)) / n() * 100)) |>
  pivot_longer(
    cols = everything(),
    names_to = "Variable",
    values_to = "% of NA"
  ) |>
  mutate(`% of NA` = round(`% of NA`, 2)) |>
  arrange(desc(`% of NA`))

na_by_column |>
  knitr::kable(caption = "Percentage of missing values per variable")
```

## 2.5.2 Country-Specific Availability

While global statistics are useful, data gaps are often concentrated in specific nations. The table below details the data coverage for each country, displaying the percentage of missing values per variable and the time period for which at least one indicator is recorded. This allows us to spot countries that may be present in the ISO list but lack sufficient data for a robust vulnerability analysis.

```{r}
data_cols <- c("temp_change", "exp_env_pct_gdp", "pc_energy_use", 
               "renew_elec_share", "top10_income_share", "pc_co2")

country_summary <- panel_complete_vars |>
  group_by(Country) |>
  summarise(
    Start_Year = min(year[if_any(all_of(data_cols), ~ !is.na(.))], na.rm = TRUE),
    End_Year   = max(year[if_any(all_of(data_cols), ~ !is.na(.))], na.rm = TRUE),
    across(all_of(data_cols), ~ round(sum(is.na(.)) / n() * 100, 1))
  ) |>
  mutate(Period = paste(Start_Year, "-", End_Year)) |>
  select(Country, Period, everything(), -Start_Year, -End_Year)

country_summary |>
  slice_head(n = 5) |>
  knitr::kable(caption = "Data availability and missing values by country (first 5 countries)")

```

To address data heterogeneity, we will adopt a modular strategy that prioritizes transparency. We will construct the three dimensions—Exposure, Sensitivity, and Adaptive Capacity—independently, calculating dimension scores only where sufficient data exists.

The final Global Vulnerability Index will be computed exclusively for countries possessing valid scores across all three dimensions. For countries with partial data, we will report dimension-level results rather than forcing an artificial composite score. 

## 2.5.3 Temporal Analysis and Period Selection

Finally, we determine the optimal time period for the analysis. There is an inherent trade-off between the length of the time series and data completeness: extending the period back to the 1960s increases the number of observations but introduces significant missing data, particularly for environmental expenditure.

The plot below visualizes data completeness over time. Based on the "plateau" observed in data availability, we define our study period as 1995–2020. This window maximizes data coverage while capturing a significant era of climate change acceleration.

```{r}
data_per_year <- panel_full |>
  group_by(year) |>
  summarise(
    n_total = n() * 6,
    n_missing = sum(is.na(temp_change) + is.na(exp_env_pct_gdp) + 
                    is.na(pc_energy_use) + is.na(renew_elec_share) + 
                    is.na(top10_income_share) + is.na(pc_co2)),
    completeness_pct = (1 - (n_missing / n_total)) * 100
  )

ggplot(data_per_year, aes(x = year, y = completeness_pct)) +
  geom_line(color = "#2c3e50", size = 1) +
  geom_point(color = "#e74c3c") +
  geom_hline(yintercept = 80, linetype = "dashed", color = "gray") +
  scale_x_continuous(breaks = seq(1960, 2024, 5)) +
  labs(
    title = "Data Availability over Time",
    subtitle = "Percentage of cells filled across all selected countries",
    y = "% of Data Available",
    x = "Year"
  ) +
  theme_minimal()
```

```{r}
period_start <- 1995
period_end   <- 2020

summary_1995_2020 <- panel_full |>
  filter(year >= period_start & year <= period_end) |>
  summarise(
    across(
      c(temp_change, exp_env_pct_gdp, pc_energy_use, 
        renew_elec_share, top10_income_share, pc_co2),
      ~ round(sum(is.na(.)) / n() * 100, 2)
    )
  ) |>
  pivot_longer(
    cols = everything(), 
    names_to = "Variable", 
    values_to = "% NA (1995-2020)"
  ) |>
  arrange(desc(`% NA (1995-2020)`))

summary_1995_2020 |>
  knitr::kable(caption = paste("Percentage of missing values from", period_start, "to", period_end))
```
# 3. Construction of the climate vulnerability index
## 3.1 Normalisation of indicators
## 3.2 Aggregation within dimensions
## 3.3 Weighting schemes and composite nidex
## 3.4 Robustness checks
# 4. Descriptive analysis and results

