---
title: "Project - Vulnerability Index"
author: "Valentine Petzold - Clémence HUANG"
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    code-fold: true
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = TRUE,
  message = FALSE,
  warning = FALSE
)
```

# 1. Introduction

[Link to our github repository](https://github.com/clemence-code/Data_management_Project)

## 1.1 Description of the project - Research question

The objective of this project is to construct a climate vulnerability index that allows a comparison of countries in terms of their vulnerability to climate change. Rather than relying on existing composite indicators, we propose to design our own multidimensional index built around three core dimensions widely used in the literature: Exposure, Sensitivity, and Adaptive Capacity. By explicitly combining these dimensions using transparent data and methods, we aim to better understand which factors drive a country’s vulnerability and to identify profiles of countries that may require differentiated policy responses. This leads us to the following research question: **How can a composite climate vulnerability index be used to compare countries and support more targeted and equitable climate adaptation policies ?**

The first dimension, Exposure, measures the degree to which each country is physically exposed to climate-related hazards. In this project, exposure will be captured using indicators from the OECD and related sources that reflect the frequency and intensity of climate hazards, as well as the extent of populations and territories at risk. The guiding idea is that two countries may differ strongly in their baseline exposure even before considering their socio-economic characteristics or institutional responses.

The second dimension, Sensitivity, reflects how strongly a country’s society and economy are affected when a climate shock occurs. This dimension will incorporate a set of social and economic indicators such as poverty rates, the Human Development Index (HDI), governance quality, and measures of income inequality. Countries with high poverty, low human development, weak institutions, or high inequality may experience more severe impacts from the same physical shock. By integrating these variables, the index aims to capture how underlying socio-economic fragilities translate into greater climate vulnerability.

The third dimension, Adaptive Capacity, captures the ability of a country to anticipate, absorb, and recover from climate-related shocks. We will focus on indicators that proxy institutional strength, technological advancement and policy commitment, such as renewable energy production, the stringency and ambition of environmental policies, and public spending on environmental and climate-related research. The assumption is that higher adaptive capacity can mitigate the negative effects of exposure and sensitivity, reducing overall vulnerability even in high-risk contexts.

Methodologically, the project will involve selecting, normalising and aggregating indicators within each dimension, and then combining the three dimensions into a composite index of climate vulnerability. We will carefully examine correlations between variables to avoid redundancy and ensure that each indicator brings distinct information. Different weighting schemes (equal weights, data-driven weights, or robustness checks with alternative specifications) may be compared. Finally, the resulting index will be analysed descriptively to identify patterns of vulnerability across countries (for example, highly exposed but relatively resilient countries versus highly sensitive and poorly equipped ones).

## 1.2 Description of data sources
-   [Organisation for Economic Co-operation and Development](https://www.oecd.org/en/data.html) : The OECD, headquartered in Paris, is an international organisation of 38 member countries committed to democracy and the market economy. Its mission is to promote policies that foster sustainable economic growth, employment and rising living standards.
    -   [Historical exposure to extreme temperatures (0ECD, 1979-2024)](https://data-explorer.oecd.org/vis?lc=en&df[ds]=dsDisseminateFinalDMZ&df[id]=DSD_ECH%40EXT_TEMP_H&df[ag]=OECD.ENV.EPI&df[vs]=2.0&dq=.A.HD_POP_EXP.........&pd=%2C&to[TIME_PERIOD]=false) For the temperature exposure data, we downloaded the series directly from the OECD Data Explorer by selecting the indicator “Historical exposure to extreme temperature” and country level data. The combined unit of measure was set to “percentage of population,” which yields the annual share of each country’s population exposed to days above 35°C. Using these filters, we obtained a dataset of 8 740 observations.
    - [Environmental Policy Stringency indicator (EPS)](https://data-explorer.oecd.org/vis?lc=en&tm=environmental%20policy&pg=0&snb=94&df%5bds%5d=dsDisseminateFinalDMZ&df%5bid%5d=DSD_EPS%40DF_EPS&df%5bag%5d=OECD.ECO.MAD&df%5bvs%5d=1.0&dq=.A..EPS&to%5bTIME_PERIOD%5d=false&pd=%2C&vw=tb)
    - [GDP expenditure on Research and Develoment](https://data-explorer.oecd.org/vis?lc=en&tm=msti&snb=1&vw=tb&df[ds]=dsDisseminateFinalDMZ&df[id]=DSD_MSTI%40DF_MSTI&df[ag]=OECD.STI.STP&df[vs]=&pd=1990%2C2024&dq=.A.G.PT_B1GQ..&to[TIME_PERIOD]=false)
- [United Nations Development Programme (UNDP) - Human development Report Office](https://hdr.undp.org/) : UNDP is the UN’s global development network, working in around 170 countries and territories to eradicate poverty, reduce inequalities and build resilient institutions. Within UNDP, the Human Development Report Office (HDRO) is responsible for producing the annual Human Development Report and developing the Human Development Index (HDI) and related indicators, which provide a multidimensional view of development by combining health, education and income measures. 
  - [Index of Human Development (1990-2025)](https://hdr.undp.org/data-center/human-development-index#/indicies/HDI)
-   [World Inequality Database](https://wid.world/) : The World Inequality Lab is a research centre based at the Paris School of Economics, bringing together economists and social scientists to study global and national inequalities in income, wealth and carbon emissions. It manages and develops the World Inequality Database (WID.world), which compiles harmonised, long-run series on the distribution of income and wealth, based on a combination of tax data, national accounts, surveys and other sources, with the aim of informing public debate and policy on inequality. [Income share of the top 10% and top 10% carbon emitters (1980-2023)](https://wid.world/data/)
-   [International Renewable Energy Agency](https://www.irena.org/) : IRENA is an intergovernmental agency that supports countries worldwide in their transition to a sustainable energy future by promoting renewable energy, providing data and analysis, and advising on energy policies and investments. [Electricity production from renewable sources (2000-2024)](https://pxweb.irena.org/pxweb/en/IRENASTAT)
-   [World bank](https://data.worldbank.org/) : The World Bank is an international financial institution headquartered in Washington, D.C., whose core mandate is to reduce poverty and promote sustainable development in low- and middle-income countries through financial support, technical assistance and policy advice. Beyond lending, the World Bank is one of the world’s main producers and disseminators of development statistics.
    -   [Per capita energy use (1990-2023)](https://data.worldbank.org/indicator/EN.GHG.CO2.PC.CE.AR5)

## 1.3 Description of the data file
### 1.3.0 Set up
```{r}
library(vroom)
library(here)
library(ggplot2)
library(dplyr)
library(readxl)
library(tidyr)
library(stringr)
library(purrr)
```

```{r}
rm(list = ls())
here::i_am('Data_management_Project.Rproj')
```

```{r}
zip_files <- list.files(
  here::here("raw_data"),
  pattern = "\\.zip$",
  full.names = TRUE
)

target_dir <- here::here("data_file")

# We unzip the zipfile in raw_data only if this folder is empty, so the extraction runs only once
if (length(list.files(target_dir)) == 0) {
  for (f in zip_files) {
    unzip(f, exdir = target_dir)
  }
}
```

### 1.3.1 Historical exposure to extreme temperatures (OECD)

The dataset we use reports, for each country and year, the share of the population exposed to “hot days”, defined as days when the daily maximum temperature exceeds 35°C.

We first import the Excel file while skipping the first six header lines. We then create a Duration variable from the rows starting with “Duration” and propagate it to all corresponding country rows. Next, we remove header rows, drop the last (non-informative) row, and delete any columns containing only missing values.

```{r}
Temperature_exposure<-read_excel("raw_data/OECD.ENV.EPI,DSD_ECH@EXT_TEMP_H,2.0,filtered,2025-11-21 14-59-03.xlsx", skip=6)

Temperature_exposure_clean <- Temperature_exposure |>
  mutate(Duration = if_else(grepl("^Duration", `Time period...1`),
                            `Time period...1`, NA_character_)) |>
  fill(Duration) |>
  filter(`Time period...1` != "Reference area",
         !grepl("^Duration", `Time period...1`)) |>
  slice(-n()) |>
  select(where(~ !all(is.na(.)))) |>
  rename(
    Country = 1
  )
```

```{r}
Temperature_exposure_summary <- bind_rows(
  Temperature_exposure |>
    summarise(
      version = "Uncleaned",
      number_of_rows = n(),
      number_of_columns = ncol(across()),
      number_of_NA = sum(is.na(across()))
    ),
  Temperature_exposure_clean |>
    summarise(
      version = "Cleaned",
      number_of_rows = n(),
      number_of_columns = ncol(across()),
      number_of_NA = sum(is.na(across()))
    )
)

Temperature_exposure_summary |>
  knitr::kable(caption = "Summary of Temperature exposure dataset (raw vs cleaned)")
```

### 1.3.2 Human Development index (UNDP)

This dataset contains annual values of the Human Development Index for most countries from 1990 onwards, combining indicators of life expectancy, education and gross national income per capita. It provides a synthetic measure of socio-economic development and human capabilities, which can be used to approximate countries’ social vulnerability and resilience to climate impacts.

We first imported the HDI Excel file while skipping the first three header rows that contain only documentation. We then removed all observations for which the first column was missing, in order to drop non-country or descriptive rows. Finally, we deleted all variables with more than 20% missing values, keeping only columns with sufficient data coverage for the analysis.

```{r}
HDI <- read_excel("raw_data/HDR25_Statistical_Annex_HDI_Table.xlsx.", skip=3)

HDI_clean <- HDI[!is.na(HDI[[1]]), ] |>
  slice(-1) |>
  select(where(~ mean(is.na(.x)) <= 0.2)) |>
  rename(
    "rank 2023"   = 1,
    Country = 2,
    "HDI Value" = 3,
    "Life expectancy at birth 2023" = 4,
    "Expected years of schooling 2023" = 5,
    "Mean years of schooling 2023" = 6,
    "Gross national income per capita 2021" = 7,
    "Gross national income rank minus HDI rank 2023" = 8,
    "HDI rank 2022" = 9
  )
```

```{r}
HDI_summary <- bind_rows(
  HDI |>
    summarise(
      version = "Uncleaned",
      number_of_rows = n(),
      number_of_columns = ncol(across()),
      number_of_NA = sum(is.na(across()))
    ),
  HDI_clean |>
    summarise(
      version = "Cleaned",
      number_of_rows = n(),
      number_of_columns = ncol(across()),
      number_of_NA = sum(is.na(across()))
    )
)

HDI_summary |>
  knitr::kable(caption = "Summary of HDI dataset (raw vs cleaned)")
```

### 1.3.3 Income share of the top 10% (WID)

This dataset offers long-run series on the income share captured by the top 10% of earners, as well as distributional information on the top 10% of carbon emitters within countries.

```{r}
Top_10_income_share <- vroom(here("data_file/WID_Data_Metadata", "WID_Data_21112025-154904.csv"), delim=";",skip=1)

Top_10_income_share_clean <- vroom(here("data_file/WID_Data_Metadata", "WID_Data_21112025-154904.csv"), delim=";",skip=1) |> select(-Percentile)

old_names <- names(Top_10_income_share_clean)
year_only <- str_extract(old_names, "\\d{4}")

# keep the year when it exists, otherwise keep the original name
names(Top_10_income_share_clean) <- ifelse(is.na(year_only), old_names, year_only)
```

```{r}
Top_10_income_share_summary <- dplyr::bind_rows(
  Top_10_income_share |>
    summarise(
      version         = "Uncleaned",
      number_of_rows  = n(),
      number_of_columns = ncol(across()),
      number_of_NA    = sum(is.na(across()))
    ),
  Top_10_income_share_clean |>
    summarise(
      version         = "Cleaned",
      number_of_rows  = n(),
      number_of_columns = ncol(across()),
      number_of_NA    = sum(is.na(across()))
    )
)

Top_10_income_share_summary |>
  knitr::kable(caption = "Summary of Top 10 income share dataset (raw vs cleaned)")

```

### 1.3.4 Environmental Policy Stringency (OECD)
For environmental policy stringency, we used the OECD Environmental Policy Stringency Index (EPS). In the Data Explorer, we selected the indicator “Environmental Policy Stringency Index (EPS)”, with **annual** frequency and **country-level** data. The measure captures the **overall strictness of environmental policies** (“Policy stringency”) across **all environmental domains** (taxes, standards, regulations and other instruments), aggregated into a single **0–6 scale** index, where higher values indicate more stringent policies. 

We first removed all rows and columns that contained only missing values, then dropped the first row, the last row and the last column, which corresponded to non-informative metadata. We also deleted the aggregate line labelled “Non-OECD economies” to keep only country-level observations. Finally, we cleaned the country names in Time period...1 by removing leading symbols and extra spaces so that entries such as “·  Brazil” are standardised as “Brazil”.

```{r}
EPS_index <- read_excel("raw_data/OECD.ECO.MAD,DSD_EPS@DF_EPS,1.0,filtered,2025-11-19 13-27-34.xlsx", skip=6)

EPS_index_clean <- EPS_index |>
  filter(if_any(everything(), ~ !is.na(.))) |>
  select(where(~ !all(is.na(.)))) |>
  slice(-1) |>
  slice(-n()) |>
  select(-dplyr::last_col()) |>
  filter(`Time period...1` != "Non-OECD economies") |>
  rename(
    Country = 1
  )

EPS_index_clean <- EPS_index_clean |>
  mutate(Country = Country |>
           str_replace("^[^A-Za-z]+", "") |>
           str_squish())
```

```{r}
EPS_index_summary <- dplyr::bind_rows(
  EPS_index |>
    summarise(
      version          = "Uncleaned",
      number_of_rows   = n(),
      number_of_columns = ncol(across()),
      number_of_NA     = sum(is.na(across()))
    ),
  EPS_index_clean |>
    summarise(
      version          = "Cleaned",
      number_of_rows   = n(),
      number_of_columns = ncol(across()),
      number_of_NA     = sum(is.na(across()))
    )
)

EPS_index_summary |>
  knitr::kable(caption = "Summary of EPS index dataset (raw vs cleaned)")
```

### 1.3.5 Share of electricity from renewable resources (IRENA)

Ember’s yearly electricity dataset provides, for each country, the breakdown of electricity generation by source (coal, gas, nuclear, hydro, wind, solar, etc.), with a particular focus on renewable technologies. It enables the construction of indicators such as the share of renewables in electricity generation, which serve as proxies for the pace of the energy transition and adaptive capacity.

We first imported the Excel file while skipping the two initial header rows, then renamed the columns to country, indicator, year, and value for clarity. We filled down the country and indicator fields so that each observation has these identifiers, and removed rows where the year was missing. We then converted the year to an integer and transformed the values from character strings with commas into numeric variables. Finally, we kept only country-level observations by excluding regional aggregates such as World, Africa, Asia or Europe.

```{r}
RE_Electricity_Share <- read_excel(here("raw_data/RESHARE_20251121-201530.xlsx"),skip=2)
```

```{r}
RE_Electricity_Share_clean <- RE_Electricity_Share |>
  rename(
    Country   = 1,
    indicator = 2,
    year      = 3,
    value     = 4
  ) |>
  fill(Country, indicator, .direction = "down") |>
  filter(!is.na(year)) |>
  mutate(
    year  = as.integer(year),
    value = value |>
      as.character() |>
      str_replace(",", ".") |>
      as.numeric()
  ) |>
  filter(
    !grepl(
      "World|Africa|Asia|Europe|America|Oceania|OECD|EU|Middle East|Eurasia",
      Country
    )
  ) |>
  filter(!is.na(Country) & Country != "")

```

```{r}
Renew_summary <- bind_rows(
  RE_Electricity_Share |>
    summarise(
      version          = "Uncleaned",
      number_of_rows   = n(),
      number_of_columns = ncol(across()),
      number_of_NA     = sum(is.na(across()))
    ),
  RE_Electricity_Share_clean |>
    summarise(
      version          = "Cleaned (countries only)",
      number_of_rows   = n(),
      number_of_columns = ncol(across()),
      number_of_NA     = sum(is.na(across()))
    )
)

Renew_summary |>
  knitr::kable(caption = "Summary of renewable electricity share dataset (raw vs cleaned)")
```

### 1.3.6 Per capita energy use (World bank)

This World Bank indicator reports total primary energy consumption per capita, expressed in kilograms of oil equivalent, for a large set of countries over time.

```{r}
PC_Energy_Use <- vroom(
  here("data_file","API_EG.USE.ELEC.KH.PC_DS2_en_csv_v2_129274.csv"),
  delim = ",",
  skip = 4
) |>
  select(where(~ !all(is.na(.)))) |>
  rename(Country = 1)

PC_Energy_Use <- PC_Energy_Use |>
  filter(
    !grepl("^(World|Asia|Europe|America|Oceania|OECD|EU|Middle East|Eurasia)",Country,ignore.case = TRUE)
)
```

```{r}
PC_Energy_Use |> 
  summarise(
    number_of_rows = n(),
    number_of_columns = ncol(across()),
    number_of_NA = sum(is.na(across()))
  ) |>
  knitr::kable()
```

### 1.3.7 Research and development as a share of GDP (OECD)
For research and development, we drew on the OECD MSTI database and selected the indicator “Gross domestic expenditure on R&D as a percentage of GDP (GERD/GDP)” at **country level** and **annual** frequency. It measures the scale of a country’s investment in innovation and knowledge creation, including in climate- and environment-related technologies, and is therefore a useful proxy for adaptive and transformative capacity.
We downloaded the full time series available (1990–2024 in the MSTI extract).

We cleaned the R&D expenditure dataset by first removing the initial header row and the last two non-informative rows, then dropping any rows and columns containing only missing values. We renamed the first column as Country and excluded aggregate entries such as the European Union, OECD and Non-OECD economies to keep only country-level observations. Finally, we standardised country names by removing leading symbols and extra spaces so that labels are consistent across datasets.

```{r}
RD_share_of_GDP <- read_excel("raw_data/OECD.STI.STP,DSD_MSTI@DF_MSTI,,filtered,2025-11-21 21-55-03.xlsx",skip=3)

RD_share_of_GDP_clean <- RD_share_of_GDP |>
  slice(-1) |>
  slice(1:(n() - 2)) |>
  filter(if_any(everything(), ~ !is.na(.))) |>
  select(where(~ !all(is.na(.)))) |>
  rename(Country = 1) |>
  filter(
    !Country %in% c(
      "European Union (27 countries from 01/02/2020)",
      "OECD",
      "Non-OECD economies"
    )
  ) |>
  mutate(
    Country = Country |>
      str_replace("^[^A-Za-z]+", "") |>
      str_squish()
  )
```

```{r}
RD_summary <- dplyr::bind_rows(
  RD_share_of_GDP |>
    summarise(
      version           = "Uncleaned",
      number_of_rows    = n(),
      number_of_columns = ncol(across()),
      number_of_NA      = sum(is.na(across()))
    ),
  RD_share_of_GDP_clean |>
    summarise(
      version           = "Cleaned",
      number_of_rows    = n(),
      number_of_columns = ncol(across()),
      number_of_NA      = sum(is.na(across()))
    )
)

RD_summary |>
  knitr::kable(caption = "Summary of R&D share of GDP dataset (raw vs cleaned)")
```

### 1.3.8 ND-Gain vulnerability index

```{r}
vulnerability<- vroom(here("data_file/resources/vulnerability", "vulnerability.csv")) |>
  rename(Country = 2)
```

```{r}
vulnerability |> 
  summarise(
    number_of_rows = n(),
    number_of_columns = ncol(across()),
    number_of_NA = sum(is.na(across()))
  ) |>
  knitr::kable()
```

### 1.3.9 CO2 emissions per capita

```{r}
PC_CO2_emissions <- vroom(here("data_file","API_EN.GHG.CO2.PC.CE.AR5_DS2_en_csv_v2_127841.csv"),
                         delim = ",",
  skip = 4)

PC_CO2_emissions_clean <- PC_CO2_emissions |>
  select(where(~ !all(is.na(.)))) |>
  rename(Country=1)
```

```{r}
PC_CO2_summary <- bind_rows(
  PC_CO2_emissions |>
    summarise(
      version           = "Uncleaned",
      number_of_rows    = n(),
      number_of_columns = ncol(across()),
      number_of_NA      = sum(is.na(across()))
    ),
  PC_CO2_emissions_clean |>
    summarise(
      version           = "Cleaned",
      number_of_rows    = n(),
      number_of_columns = ncol(across()),
      number_of_NA      = sum(is.na(across()))
    )
)

PC_CO2_summary |>
  knitr::kable(caption = "Summary of CO2 emissions per capita dataset (raw vs cleaned)")
```

### 1.3.10 World Development Indicator

```{r}
WDI<- read_excel("data_file/wgidataset.xlsx")
```

```{r}
WDI |> 
  summarise(
    number_of_rows = n(),
    number_of_columns = ncol(across()),
    number_of_NA = sum(is.na(across()))
  ) |>
  knitr::kable()
```

# 2. Data joining

In this section, we first remove regional or aggregate units that do not correspond to individual countries from the World Bank–based datasets. We then summarise the cleaned datasets, reshape each of them into a long country–year format, and harmonise country identifiers by adding iso3c codes using the `countrycode` package and a manual correction dictionary. Finally, we merge all sources into a single panel, attach Human Development Index (HDI) variables, and identify both the matched panel (countries present in all datasets) and the list of remaining units without an iso3c match.

## 2.1 Removing non-country units

```{r non_country_units}
non_country_units <- c(
  "Africa Eastern and Southern",
  "Africa Western and Central",
  "Arab World",
  "Caribbean small states",
  "Central Europe and the Baltics",
  "Channel Islands",
  "Early-demographic dividend",
  "East Asia & Pacific",
  "East Asia & Pacific (IDA & IBRD countries)",
  "East Asia & Pacific (excluding high income)",
  "East Asia (MER)",
  "East Asia (PPP)",
  "Eastern Europe (MER)",
  "Eastern Europe (PPP)",
  "Europe (MER)",
  "Europe (PPP)",
  "Fragile and conflict affected situations",
  "Heavily indebted poor countries (HIPC)",
  "High income",
  "IBRD only",
  "IDA & IBRD total",
  "IDA blend",
  "IDA only",
  "IDA total",
  "Kosovo",
  "Late-demographic dividend",
  "Latin America & Caribbean",
  "Latin America & Caribbean (excluding high income)",
  "Latin America & the Caribbean (IDA & IBRD countries)",
  "Latin America (MER)",
  "Latin America (PPP)",
  "Least developed countries: UN classification",
  "Low & middle income",
  "Low income",
  "Lower middle income",
  "MENA (MER)",
  "MENA (PPP)",
  "Micronesia",
  "Middle income",
  "North America",
  "North America & Oceania (MER)",
  "North America & Oceania (PPP)",
  "North America (MER)",
  "North America (PPP)",
  "Not classified",
  "Oceania (MER)",
  "Oceania (PPP)",
  "Other East Asia (MER)",
  "Other East Asia (PPP)",
  "Other Latin America (MER)",
  "Other Latin America (PPP)",
  "Other MENA (MER)",
  "Other MENA (PPP)",
  "Other North America & Oceania (MER)",
  "Other North America & Oceania (PPP)",
  "Other North America (MER)",
  "Other North America (PPP)",
  "Other Oceania (MER)",
  "Other Oceania (PPP)",
  "Other South & Southeast Asia (MER)",
  "Other South & Southeast Asia (PPP)",
  "Other Sub-Saharan Africa (MER)",
  "Other Sub-Saharan Africa (PPP)",
  "Other Western Europe (MER)",
  "Other Western Europe (PPP)",
  "Other small states",
  "Pacific island small states",
  "Post-demographic dividend",
  "Pre-demographic dividend",
  "Small states",
  "South & Southeast Asia (MER)",
  "South & Southeast Asia (PPP)",
  "South Asia",
  "South Asia (IDA & IBRD)",
  "Sub-Saharan Africa",
  "Sub-Saharan Africa (IDA & IBRD countries)",
  "Sub-Saharan Africa (MER)",
  "Sub-Saharan Africa (PPP)",
  "Sub-Saharan Africa (excluding high income)",
  "Upper middle income",
  "World (MER)",
  "World (PPP)"
)

PC_Energy_Use <- PC_Energy_Use |>
  dplyr::filter(!Country %in% non_country_units)

RE_Electricity_Share_clean <- RE_Electricity_Share_clean |>
  dplyr::filter(!Country %in% non_country_units)

Top_10_income_share_clean <- Top_10_income_share_clean |>
  dplyr::filter(!Country %in% non_country_units)
```

## 2.2 Summary of rows and columns

```{r datasets_overview}
datasets_overview <- tibble(
  dataset = c(
    "Temperature exposure",
    "Human Development Index",
    "Top 10 income share",
    "Environmental Policy Stringency (EPS)",
    "Renewable electricity share",
    "Per capita energy use",
    "R&D expenditure (% of GDP)",
    "ND-GAIN vulnerability index",
    "CO2 emissions per capita",
    "Worldwide Governance Indicators"
  ),
  version = c(
    "Cleaned",
    "Cleaned",
    "Cleaned",
    "Cleaned",
    "Cleaned (countries only)",
    "Cleaned",
    "Cleaned",
    "Original",
    "Cleaned",
    "Original"
  ),
  number_of_rows = c(
    nrow(Temperature_exposure_clean),
    nrow(HDI_clean),
    nrow(Top_10_income_share_clean),
    nrow(EPS_index_clean),
    nrow(RE_Electricity_Share_clean),
    nrow(PC_Energy_Use),
    nrow(RD_share_of_GDP_clean),
    nrow(vulnerability),
    nrow(PC_CO2_emissions_clean),
    nrow(WDI)
  ),
  number_of_columns = c(
    ncol(Temperature_exposure_clean),
    ncol(HDI_clean),
    ncol(Top_10_income_share_clean),
    ncol(EPS_index_clean),
    ncol(RE_Electricity_Share_clean),
    ncol(PC_Energy_Use),
    ncol(RD_share_of_GDP_clean),
    ncol(vulnerability),
    ncol(PC_CO2_emissions_clean),
    ncol(WDI)
  )
)

datasets_overview |>
  knitr::kable(caption = "Summary of cleaned datasets used in the analysis")
```

## 2.3 Long format of each datafile

```{r long_format}
Temperature_long <- Temperature_exposure_clean |>
  select(Country, matches("^\\d{4}$")) |>
  pivot_longer(
    cols      = matches("^\\d{4}$"),
    names_to  = "year",
    values_to = "share_hot_days"
  ) |>
  mutate(year = as.integer(year))

EPS_long <- EPS_index_clean |>
  select(Country, matches("^\\d{4}$")) |>
  pivot_longer(
    cols      = matches("^\\d{4}$"),
    names_to  = "year",
    values_to = "eps_index"
  ) |>
  mutate(year = as.integer(year))

RD_long <- RD_share_of_GDP_clean |>
  select(Country, matches("^\\d{4}$")) |>
  pivot_longer(
    cols      = matches("^\\d{4}$"),
    names_to  = "year",
    values_to = "rd_gdp"
  ) |>
  mutate(year = as.integer(year))

PC_Energy_long <- PC_Energy_Use |>
  select(Country, matches("^\\d{4}$")) |>
  pivot_longer(
    cols      = matches("^\\d{4}$"),
    names_to  = "year",
    values_to = "pc_energy_use"
  ) |>
  mutate(year = as.integer(year))

RE_long <- RE_Electricity_Share_clean |>
  transmute(
    Country,
    year             = as.integer(year),
    renew_elec_share = value
  )

Top_10_income_share_clean2 <- Top_10_income_share_clean |>
  rename(Country = 1)
```

## 2.4 Adding countrycode as key

```{r add_iso3}
library(countrycode)

Top10_long <- Top_10_income_share_clean2 |>
  select(Country, matches("^\\d{4}$")) |>
  pivot_longer(
    cols      = matches("^\\d{4}$"),
    names_to  = "year",
    values_to = "top10_income_share"
  ) |>
  mutate(year = as.integer(year))

Temperature_long <- Temperature_long |>
  mutate(iso3c = countrycode(Country, "country.name", "iso3c"))

EPS_long <- EPS_long |>
  mutate(iso3c = countrycode(Country, "country.name", "iso3c"))

RD_long <- RD_long |>
  mutate(iso3c = countrycode(Country, "country.name", "iso3c"))

PC_Energy_long <- PC_Energy_long |>
  mutate(iso3c = countrycode(Country, "country.name", "iso3c"))

RE_long <- RE_long |>
  mutate(iso3c = countrycode(Country, "country.name", "iso3c"))

Top10_long <- Top10_long |>
  mutate(iso3c = countrycode(Country, "country.name", "iso3c"))

HDI_clean <- HDI_clean |>
  mutate(iso3c = countrycode(Country, "country.name", "iso3c"))

manual_iso3 <- c(
  "Congo, Dem. Rep."                      = "COD",
  "Congo, Rep."                           = "COG",
  "Bahamas, The"                          = "BHS",
  "Gambia, The"                           = "GMB",
  "Russian Federation"                    = "RUS",
  "Viet Nam"                              = "VNM",
  "Côte d’Ivoire"                         = "CIV",
  "Cote d Ivoire"                         = "CIV",
  "China, P.R.: Mainland"                 = "CHN",
  "China (People's Republic of)"          = "CHN",
  "China, People’s Republic of"           = "CHN",
  "China, Mainland"                       = "CHN",
  "China"                                 = "CHN",
  "Hong Kong SAR, China"                  = "HKG",
  "China, Hong Kong SAR"                  = "HKG",
  "China, P.R.: Hong Kong"                = "HKG",
  "Macao SAR, China"                      = "MAC",
  "China, Macao SAR"                      = "MAC",
  "China, P.R.: Macao"                    = "MAC",
  "China, Taiwan Province of China"       = "TWN",
  "Taiwan, Province of China"             = "TWN",
  "Taiwan, China"                         = "TWN",
  "Taiwan (Province of China)"            = "TWN",
  "Korea, Rep."                           = "KOR",
  "Republic of Korea"                     = "KOR",
  "Korea, Dem. People's Rep."             = "PRK",
  "Democratic People's Republic of Korea" = "PRK",
  "Iran, Islamic Rep."                    = "IRN",
  "Islamic Republic of Iran"              = "IRN",
  "Syrian Arab Republic"                  = "SYR",
  "Egypt, Arab Rep."                      = "EGY",
  "Arab Republic of Egypt"                = "EGY",
  "Yemen, Rep."                           = "YEM",
  "West Bank and Gaza"                    = "PSE",
  "Palestine, State of"                   = "PSE",
  "Slovak Republic"                       = "SVK",
  "Czech Republic"                        = "CZE",
  "Republic of Moldova"                   = "MDA",
  "Moldova, Republic of"                  = "MDA",
  "North Macedonia"                       = "MKD",
  "Macedonia, FYR"                        = "MKD",
  "Kyrgyz Republic"                       = "KGZ",
  "Lao PDR"                               = "LAO",
  "Brunei Darussalam"                     = "BRN",
  "Myanmar"                               = "MMR",
  "Cabo Verde"                            = "CPV",
  "Swaziland"                             = "SWZ",
  "Eswatini"                              = "SWZ",
  "Bolivia (Plurinational State of)"      = "BOL",
  "Bolivia, Plurinational State of"       = "BOL",
  "Venezuela, RB"                         = "VEN"
)

fix_iso3 <- function(df) {
  df |>
    mutate(
      iso3c = if_else(
        is.na(iso3c) & Country %in% names(manual_iso3),
        manual_iso3[Country],
        iso3c
      )
    )
}

Temperature_long <- fix_iso3(Temperature_long)
EPS_long         <- fix_iso3(EPS_long)
RD_long          <- fix_iso3(RD_long)
PC_Energy_long   <- fix_iso3(PC_Energy_long)
RE_long          <- fix_iso3(RE_long)
Top10_long       <- fix_iso3(Top10_long)
HDI_clean        <- fix_iso3(HDI_clean)

datasets_long_iso <- list(
  Temperature_long,
  EPS_long,
  RD_long,
  PC_Energy_long,
  RE_long,
  Top10_long
)
```

## 2.5 Creating panel data
```{r create_panel}
panel_full <- reduce(
  datasets_long_iso,
  ~ full_join(.x, .y, by = c("iso3c", "year"))
)

ref_names <- HDI_clean |>
  select(iso3c, Country) |>
  distinct() |>
  rename(Country_std = Country)

HDI_vars <- HDI_clean |>
  select(
    iso3c,
    `HDI Value`,
    `Life expectancy at birth 2023`,
    `Expected years of schooling 2023`,
    `Mean years of schooling 2023`,
    `Gross national income per capita 2021`,
    `Gross national income rank minus HDI rank 2023`,
    `rank 2023`,
    `HDI rank 2022`
  )

panel_full <- panel_full |>
  left_join(ref_names, by = "iso3c") |>
  left_join(HDI_vars,  by = "iso3c")

country_list <- list(
  Temperature = Temperature_long,
  EPS         = EPS_long,
  RD          = RD_long,
  PC_Energy   = PC_Energy_long,
  Renewables  = RE_long,
  Top10       = Top10_long,
  HDI         = HDI_clean
)

country_coverage <- imap_dfr(
  country_list,
  ~ tibble(iso3c = unique(.x$iso3c), dataset = .y)
)

country_coverage_wide <- country_coverage |>
  mutate(value = TRUE) |>
  pivot_wider(
    names_from  = dataset,
    values_from = value,
    values_fill = FALSE
  )

matched_iso3 <- country_coverage_wide |>
  filter(if_all(-iso3c, ~ .x)) |>
  pull(iso3c)

panel_matched <- panel_full |>
  filter(iso3c %in% matched_iso3)

matched_countries <- ref_names |>
  filter(iso3c %in% matched_iso3) |>
  arrange(Country_std)
```

# 3. Construction of the climate vulnerability dex
## 3.1 Normalisation of indicators
## 3.2 Aggregation within dimensions
## 3.3 Weighting schemes and composite nidex
## 3.4 Robustness checks
# 4. Descriptive analysis and results

